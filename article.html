<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article | Siliguri News & Community</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="assets/js/tailwind-config.js"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Inter:wght@400;500;700;800;900&family=Space+Mono:wght@700&display=swap"
        rel="stylesheet">

    <!-- Custom Stylesheet -->
    <link rel="stylesheet" href="assets/css/style.css">

    <!-- Quill.js for Rich Text Formatting -->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet" />
    <style>
        /* Minimal custom styling for quill injected content */
        .ql-editor {
            padding: 0;
            min-height: auto;
            font-family: 'Georgia', serif;
        }

        .ql-editor h1,
        .ql-editor h2,
        .ql-editor h3 {
            font-family: 'Playfair Display', serif;
            font-weight: bold;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .ql-editor h1 {
            font-size: 2.25rem;
        }

        .ql-editor h2 {
            font-size: 1.875rem;
        }

        .ql-editor p {
            margin-bottom: 1.25rem;
            font-size: 1.125rem;
            line-height: 1.8;
            color: #111827;
            /* Darker for better contrast */
        }

        .ql-editor a {
            color: #2563EB;
            text-decoration: underline;
            transition: color 0.15s ease-in-out;
        }

        .ql-editor a:hover {
            color: #1D4ED8;
        }

        .ql-editor img {
            max-width: 100%;
            border-radius: 0.5rem;
            margin: 2rem 0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .ql-editor ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1.25rem;
            font-size: 1.125rem;
        }

        .ql-editor ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin-bottom: 1.25rem;
            font-size: 1.125rem;
        }

        .ql-editor blockquote {
            border-left: 4px solid #FDE047;
            padding-left: 1rem;
            font-style: italic;
            color: #4B5563;
            margin-bottom: 1.25rem;
        }

        /* Dark Mode Overrides for Quill */
        .dark .ql-editor p,
        .dark .ql-editor ul,
        .dark .ql-editor ol {
            color: #e5e7eb;
        }

        .dark .ql-editor h1,
        .dark .ql-editor h2,
        .dark .ql-editor h3 {
            color: #ffffff;
        }

        .dark .ql-editor a {
            color: #60a5fa;
        }

        .dark .ql-editor a:hover {
            color: #93c5fd;
        }

        .dark .ql-editor blockquote {
            color: #9ca3af;
        }
    </style>
    <style>
        .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .dark .glass-header {
            background: rgba(18, 18, 18, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-scrolled {
            transition: all 0.3s ease;
        }

        #readingProgress {
            transition: width 0.1s ease-out;
        }

        /* Custom Google Translate Widget Styles to match theme */
        .goog-te-gadget {
            font-family: inherit !important;
            color: transparent !important;
        }

        .goog-te-gadget .goog-te-combo {
            color: #000;
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            line-height: 1.25rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .goog-te-gadget .goog-te-combo:focus {
            border-color: #facc15;
            /* brandYellow */
            box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.2);
        }

        .goog-logo-link,
        .goog-te-gadget span,
        .goog-te-banner-frame {
            display: none !important;
        }

        body {
            top: 0 !important;
        }
    </style>
</head>

<body
    class="bg-gray-50 dark:bg-[#121212] text-gray-900 dark:text-gray-100 font-sans antialiased transition-colors duration-300">
    <!-- HEADER OVERLAY (Simplified for Reader) -->
    <header id="mainHeader"
        class="bg-brandYellow dark:bg-[#1a1a1a] sticky top-0 w-full h-[80px] md:h-[120px] flex flex-col justify-center border-b border-black dark:border-gray-800 z-[80] transition-all duration-300">
        <div class="w-full px-4 md:px-10 flex justify-between items-center z-[60] relative">
            <a href="index.html"
                class="font-serif italic text-3xl font-bold hover:opacity-80 transition dark:text-white">Siliguri<span
                    class="text-black dark:text-brandYellow">.</span></a>
            <a href="index.html" class="font-mono text-sm font-bold uppercase hover:underline">Back to Stories</a>
        </div>
        </div>
        <!-- Reading Progress Bar attached to bottom of header -->
        <div id="progressBarContainer" class="absolute bottom-0 left-0 w-full h-[4px] z-[100] bg-transparent">
            <div id="progressBar" class="h-full bg-blue-600 w-0 transition-all duration-75"></div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main
        class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 mt-12 pb-24 min-h-[60vh] bg-white dark:bg-[#1e1e1e] shadow-xl shadow-gray-200/50 dark:shadow-none rounded-xl my-8 md:p-12 p-6 border border-gray-100 dark:border-gray-800">
        <div id="loadingIndicator" class="text-center py-20 font-bold font-mono text-lg animate-pulse text-gray-400">
            Loading story...
        </div>

        <article id="articleContent" class="hidden">
            <!-- Rendered via JS -->
        </article>

        <div id="errorIndicator" class="hidden text-center py-20">
            <!-- Rendered via JS -->
        </div>
    </main>

    <!-- Simple Footer -->
    <footer class="bg-black dark:bg-[#111] text-white py-12 border-t-[16px] border-brandYellow dark:border-yellow-600">
        <div
            class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-col md:flex-row justify-between items-center gap-6">
            <h2 class="font-serif italic text-5xl md:text-6xl text-brandYellow">Siliguri.</h2>
            <div class="flex gap-6 font-mono text-sm">
                <a href="#" class="hover:text-brandYellow">About</a>
                <a href="#" class="hover:text-brandYellow">Contact</a>
                <a href="#" class="hover:text-brandYellow">Privacy</a>
            </div>
            <p class="text-gray-400 text-xs">Â© 2026 Siliguri News Network. Siliguri, WB.</p>
        </div>
    </footer>

    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Fetch Script -->
    <script>
        const supabaseUrl = 'https://dssxoikkhszevavriutc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRzc3hvaWtraHN6ZXZhdnJpdXRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2NjA3NDEsImV4cCI6MjA4NzIzNjc0MX0.SJx4tz808lDKuiNE3lXY4kAT_ikwTTxNlacbhYpUvZw';
        const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);

        async function loadArticle() {
            const params = new URLSearchParams(window.location.search);
            const articleId = params.get('id');

            if (!articleId) {
                showError();
                return;
            }

            try {
                // Check current user session and subscription status
                const { data: { session } } = await supabaseClient.auth.getSession();
                let userSub = null;
                const currentUser = session?.user;

                if (currentUser) {
                    const { data: subData } = await supabaseClient
                        .from('subscriptions')
                        .select('*')
                        .eq('email', currentUser.email)
                        .single();
                    userSub = subData;
                }

                // Try fetching from Supabase
                const { data, error } = await supabaseClient
                    .from('articles')
                    .select('*')
                    .eq('id', articleId)
                    .single();

                if (data && !error) {
                    renderArticle(data, currentUser, userSub);
                } else {
                    // Fallback to local
                    const fallbackResponse = await fetch('data/data.json');
                    const fallbackData = await fallbackResponse.json();

                    let found = null;
                    if (fallbackData.mainFeature && fallbackData.mainFeature.id === articleId) {
                        found = fallbackData.mainFeature;
                    } else if (fallbackData.articles) {
                        found = fallbackData.articles.find(a => a.id.toString() === articleId.toString());
                    }

                    if (found) {
                        renderArticle(found, currentUser, userSub);
                    } else {
                        showError();
                    }
                }
            } catch (err) {
                console.error(err);
                showError();
            }
        }

        function renderArticle(article, currentUser, userSub) {
            document.getElementById('loadingIndicator').classList.add('hidden');
            const container = document.getElementById('articleContent');
            container.classList.remove('hidden');

            let contentHTML = article.content || (article.excerpt ? `<p>${article.excerpt}</p>` : '');

            // --- PAYWALL LOGIC ---
            if (article.type === 'premium') {
                const isAuthor = currentUser && currentUser.email === article.author_email;
                const isSuperAdmin = currentUser && currentUser.email === 'subhamdey.one@gmail.com';
                const isPro = userSub && userSub.plan_tier === 'pro';

                if (!isAuthor && !isSuperAdmin && !isPro) {
                    // User needs to pay. Truncate content to first 300 chars roughly.
                    const plainText = contentHTML.replace(/<[^>]*>?/gm, ''); // strip HTML
                    const snippet = plainText.substring(0, 300) + '...';

                    contentHTML = `
                        <p class="mb-4 text-gray-900 dark:text-gray-200">${snippet}</p>
                        
                        <div class="relative w-full my-12 rounded-xl overflow-hidden shadow-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-[#1a1a1a]">
                            <!-- Premium Background Pattern -->
                            <div class="absolute inset-0 opacity-10 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxwYXRoIGQ9Ik0wIDBoNDB2NDBIMHoiIGZpbGw9Im5vbmUiLz4KPHBhdGggZD0iTTIwIDIwTDEwIDEwTDIwIDAgbDEwIDEwLDEwIDEwem0wIDIwbC0xMC0xMGwtMTAgMTBMMCA0MGwxMC0xMGwxMCAxMHoiIGZpbGw9IiMwMDAiLz4KPC9zdmc+')] dark:invert"></div>
                            
                            <div class="relative z-10 p-8 md:p-12 text-center flex flex-col items-center justify-center bg-gradient-to-b from-white/90 to-white/100 dark:from-[#1a1a1a]/90 dark:to-[#1a1a1a]/100 backdrop-blur-sm">
                                <span class="bg-black dark:bg-yellow-500 text-brandYellow dark:text-black text-xs font-bold font-mono px-3 py-1 uppercase tracking-widest mb-4 inline-block shadow-sm">Exclusive Content</span>
                                <h3 class="font-serif font-bold text-3xl md:text-4xl text-black dark:text-white mb-4">Subscribe to keep reading</h3>
                                <p class="text-gray-600 dark:text-gray-300 mb-8 max-w-md mx-auto text-lg leading-relaxed">This deep dive is available exclusively to Siliguri Pro members. Join our community and support local journalism.</p>
                                
                                <div class="w-full max-w-sm">
                                    <button onclick="window.location.href='index.html?openUpgrade=member'" class="w-full bg-brandYellow dark:bg-yellow-500 hover:bg-yellow-400 dark:hover:bg-yellow-400 text-black font-bold py-4 rounded transition text-lg shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] dark:shadow-none active:shadow-[0px_0px_0px_0px_rgba(0,0,0,1)] active:translate-x-1 active:translate-y-1">
                                        Unlock for â‚¹30/month
                                    </button>
                                    <p class="text-sm font-bold mt-4 text-gray-500 dark:text-gray-400">Or <a href="index.html?openAuth=true" class="text-black dark:text-white underline cursor-pointer hover:opacity-80 transition">Sign In</a> if you're already a member.</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            // --- END PAYWALL LOGIC ---
            const imgSrc = article.image_url || article.image || 'https://images.unsplash.com/photo-1546422904-90eab23c3d7e?q=80&w=800&auto=format&fit=crop';
            const author = article.author_name || article.author || 'Editorial';
            const date = article.created_at ? new Date(article.created_at).toLocaleDateString() : (article.date || 'Today');
            const premiumTagHTML = article.type === 'premium' ? '<span class="font-mono text-xs font-bold uppercase tracking-widest text-black bg-brandYellow px-2 py-1 ml-2">Premium Content</span>' : '';

            // Format article using standard typography combined with Quill's .ql-editor class
            container.innerHTML = `
                <div class="mb-6 flex gap-2">
                    <span class="font-mono text-xs font-bold uppercase tracking-widest text-brandYellow bg-black dark:text-black dark:bg-yellow-500 px-2 py-1">${article.category || 'News'}</span>
                    ${premiumTagHTML}
                </div>
                <h1 class="font-serif font-bold text-4xl md:text-5xl lg:text-6xl text-black dark:text-white leading-tight mb-6">${article.title}</h1>
                
                <div class="flex items-center gap-4 mb-4 border-t border-gray-200 dark:border-gray-800 pt-4 mt-8">
                    <div class="w-12 h-12 bg-gray-200 dark:bg-gray-800 rounded-full flex items-center justify-center font-bold text-gray-500 dark:text-gray-400 uppercase shrink-0">
                        ${author.charAt(0)}
                    </div>
                    <div class="flex-1 flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <div>
                            <div class="font-bold text-gray-900 dark:text-white">${author}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400 font-mono tracking-wide uppercase">${date}</div>
                        </div>
                        
                        <!-- Translate Widget -->
                        <div class="flex items-center gap-2 bg-gray-50 dark:bg-gray-800 px-3 py-2 rounded border border-gray-100 dark:border-gray-700 self-start sm:self-auto">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                            </svg>
                            <div id="google_translate_element"></div>
                        </div>
                    </div>
                </div>

                ${imgSrc ? `
                <div class="w-full mb-10 overflow-hidden shadow-lg border border-gray-100 dark:border-gray-800 dark:shadow-none rounded-lg">
                    <img src="${imgSrc}" alt="${article.title}" class="w-full object-cover" loading="lazy">
                </div>
                ` : ''}

                <div class="ql-editor prose prose-lg dark:prose-invert max-w-none text-gray-900 dark:text-gray-200">
                    ${contentHTML}
                </div>
            `;

            document.title = article.title + ' | Siliguri News & Community';

            // Force Tailwind CDN to rescan the DOM since we injected new HTML dynamically
            if (window.tailwind) {
                // Tailwind CDN usually observes mutations, but sometimes misses fast dynamic inserts.
                // An empty style tag injection or class toggle can force a re-evaluation
                const forceStyle = document.createElement('style');
                document.head.appendChild(forceStyle);
                setTimeout(() => forceStyle.remove(), 10);
            }
        }

        async function showError() {
            document.getElementById('loadingIndicator').classList.add('hidden');

            try {
                // Fetch trending to show
                const fallbackResponse = await fetch('data/data.json');
                const fallbackData = await fallbackResponse.json();
                const trending = fallbackData.articles.slice(0, 3);

                let trendingHtml = '<div class="mt-16 text-left"><h3 class="font-bold text-2xl mb-6 text-black dark:text-white border-b-2 border-brandYellow dark:border-yellow-600 pb-2 inline-block">Trending Stories</h3><div class="grid grid-cols-1 sm:grid-cols-3 gap-6">';
                trending.forEach(a => {
                    const img = a.image_url || a.image || 'https://images.unsplash.com/photo-1546422904-90eab23c3d7e?q=80&w=800&auto=format&fit=crop';
                    trendingHtml += `<a href="article.html?id=${a.id}" class="group block"><img src="${img}" class="w-full aspect-[3/2] object-cover mb-3 group-hover:opacity-80 transition rounded"><h4 class="font-bold text-lg leading-tight text-gray-900 dark:text-gray-100 group-hover:text-blue-700 dark:group-hover:text-blue-400 transition">${a.title}</h4></a>`;
                });
                trendingHtml += '</div></div>';

                document.getElementById('errorIndicator').innerHTML = `
                    <div class="mb-4">
                        <span class="text-6xl block mb-4">ðŸ“°</span>
                        <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white">Story not found.</h2>
                        <p class="text-gray-600 dark:text-gray-400 mt-2 text-lg">The article you're looking for might have been removed or the link is broken. <a href="index.html" class="text-blue-600 dark:text-blue-400 font-bold hover:underline">Return to homepage</a>.</p>
                    </div>
                    ${trendingHtml}
                `;
            } catch (err) {
                document.getElementById('errorIndicator').innerHTML = '<h2 class="text-2xl font-bold text-gray-900 dark:text-white">Story not found.</h2><a href="index.html" class="text-blue-600 dark:text-blue-400 hover:underline">Return home</a>.';
            }

            document.getElementById('errorIndicator').classList.remove('hidden');
        }

        // Header scroll effect and Progress Bar
        window.addEventListener('scroll', () => {
            const header = document.getElementById('mainHeader');
            if (window.scrollY > 50) {
                header.classList.add('glass-header', 'shadow-md', 'dark:shadow-none');
                header.classList.remove('bg-brandYellow', 'dark:bg-yellow-600');
            } else {
                header.classList.remove('glass-header', 'shadow-md', 'dark:shadow-none');
                header.classList.add('bg-brandYellow', 'dark:bg-yellow-600');
            }

            // Progress bar logic
            const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
            const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
            const scrolled = (winScroll / height) * 100;
            document.getElementById("progressBar").style.width = scrolled + "%";
        });

        // Setup Google Translate Initialization
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
        }

        // Run on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadArticle();
        });
    </script>

    <!-- Google Translate Script -->
    <script type="text/javascript"
        src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</body>

</html>